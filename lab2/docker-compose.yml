x-app-build: &app_build
  build:
    context: .
    dockerfile: Dockerfile
  image: lab2-app:1.0

x-app-image: &app_image
  image: lab2-app:1.0

services:
  app:
    <<: *app_build
    container_name: lab2-app
    env_file:
      - .env
    volumes:
      - app_data:/data
    networks:
      - lab2-net
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=2).read()\""
        ]
      interval: 10s
      timeout: 3s
      retries: 10


  init:
    <<: *app_image
    container_name: lab2-init
    env_file:
      - .env
    volumes:
      - app_data:/data
      - ./init:/init:ro
    networks:
      - lab2-net
    entrypoint: ["sh", "/init/init.sh"]
    restart: "no"

  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: lab2-nginx:1.0
    container_name: lab2-nginx
    depends_on:
      app:
        condition: service_healthy
    ports:
      - "${PUBLIC_PORT}:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - lab2-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -fsS http://localhost:8080/health || exit 1" ]
      interval: 10s
      timeout: 3s
      retries: 10


volumes:
  app_data:

networks:
  lab2-net:
    name: lab2-net
    driver: bridge
