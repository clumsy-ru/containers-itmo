# Лабораторная работа №2  
## Контейнеризация и оркестрация (Docker Compose)

---

## Цель работы

Целью лабораторной работы является освоение оркестрации контейнеров с использованием Docker Compose: описание нескольких сервисов в одном compose-файле, настройка их взаимодействия, зависимостей, сетей, томов, переменных окружения и проверки состояния сервисов.

---

## Общая структура проекта

Проект разворачивается с помощью `docker-compose.yml` и состоит из трёх сервисов:

- **init** — одноразовый сервис инициализации данных;
- **app** — основное web-приложение на Flask;
- **nginx** — reverse proxy для проксирования HTTP-запросов к приложению.

Все сервисы управляются через Docker Compose и находятся в одной пользовательской сети.

---

## Описание docker-compose.yml

### Сеть (network)

В compose-файле определена пользовательская bridge-сеть:

```yaml
networks:
  lab2-net:
    driver: bridge
```

Все сервисы подключены к этой сети и могут обращаться друг к другу по имени сервиса.

---

### Тома (volumes)

```yaml
volumes:
  app_data:
```

Docker volume `app_data` используется для хранения данных приложения (`counter.txt`, `app.log`) и подключается к сервисам `init` и `app`.  
Это обеспечивает сохранность данных между перезапусками контейнеров.

---

## Описание сервисов

### 1. init — сервис инициализации

**Назначение:**  
Одноразовый сервис, подготавливающий рабочую директорию `/data` и необходимые файлы данных при первом запуске.

**Особенности:**

- использует тот же Docker-образ, что и `app`;
- запускается через `entrypoint`;
- завершается после выполнения (one-shot);
- не перезапускается.

Пример конфигурации:

```yaml
init:
  image: lab2-app:1.0
  entrypoint: ["sh", "/init/init.sh"]
  restart: "no"
```

---

### 2. app — основное приложение

**Назначение:**  
Flask-приложение, которое:

- обрабатывает HTTP-запросы;
- хранит состояние в `/data`;
- предоставляет эндпоинты `/` и `/health`.

**Особенности:**

- образ собирается из локального `Dockerfile`;
- переменные окружения подключаются через `env_file`;
- используется Docker volume;
- реализован `healthcheck`.

Пример конфигурации:

```yaml
app:
  build:
    context: .
    dockerfile: Dockerfile
  image: lab2-app:1.0
  volumes:
    - app_data:/data
```

---

### 3. nginx — reverse proxy

**Назначение:**  
Принимает входящие HTTP-запросы и проксирует их в сервис `app`.

**Особенности:**

- использует отдельный Dockerfile для установки `curl`;
- пробрасывает порт контейнера на хост;
- запускается только после успешного старта `app`;
- имеет собственный `healthcheck`.

Пример конфигурации:

```yaml
nginx:
  ports:
    - "${PUBLIC_PORT}:8080"
  depends_on:
    app:
      condition: service_healthy
```

---

## Переменные окружения

Все переменные окружения вынесены в файл `.env` и подключаются через `env_file`.

Пример `.env`:

```env
DATA_DIR=/data
PUBLIC_PORT=8000
```

Это позволяет отделить конфигурацию от compose-файла.

---

## Проверка состояния сервисов (healthcheck)

В проекте используется механизм `healthcheck`:

- сервис `app` проверяется HTTP-запросом к `/health`;
- сервис `nginx` проверяется HTTP-запросом к проксируемому эндпоинту.

Состояние сервисов отображается командой:

```bash
docker compose ps
```

---

## Запуск и управление проектом

### Сборка и запуск

```bash
docker compose up -d --build
```

### Остановка

```bash
docker compose down
```

### Просмотр логов

```bash
docker compose logs app
docker compose logs init
docker compose logs nginx
```

---

## Ответы на вопросы из методических указаний

### Можно ли ограничивать ресурсы контейнеров (CPU/RAM)?

Да, Docker Compose позволяет ограничивать ресурсы контейнеров, например:

```yaml
mem_limit: 512m
cpus: 1.0
```

Следует учитывать, что директива `deploy.resources` предназначена для Docker Swarm и может игнорироваться при использовании обычного `docker compose`.

---

### Как запустить только один сервис, не запуская остальные?

Для запуска одного сервиса используется команда:

```bash
docker compose up app
```

Для одноразового запуска сервиса инициализации:

```bash
docker compose run --rm init
```

---

## Итог

В ходе лабораторной работы был создан многоконтейнерный проект с использованием Docker Compose. Реализованы:

- оркестрация нескольких сервисов;
- инициализация данных;
- хранение состояния в volumes;
- проверка состояния контейнеров;
- проксирование HTTP-запросов через nginx.
